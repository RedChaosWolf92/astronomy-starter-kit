#!/bin/bash
#
# ASTRONOMY STARTER KIT - Smart Launcher
# Zero-configuration astronomy development environment
#
# Repository: https://github.com/RedChaosWolf92/astronomy-starter-kit
# Version: 1.1.0
# License: MIT
#
# Tested on: Ubuntu 22.04 LTS, Ubuntu 24.04 LTS
#
# Installation:
#   curl -sSL https://raw.githubusercontent.com/RedChaosWolf92/astronomy-starter-kit/main/astronomyinstaller.sh | bash
#
# Usage:
#   astro              # First run: auto-installs everything
#   astro              # Subsequent runs: shows menu
#   astro jupyter      # Launch Jupyter Lab
#   astro topcat       # Launch TOPCAT
#   astro ds9          # Launch DS9 image viewer
#   astro python       # Launch Python with astronomy environment
#   astro status       # Show installation status
#   astro doctor       # Check environment health
#   astro repair       # Repair broken components
#   astro update       # Update packages
#   astro uninstall    # Remove everything cleanly
#   astro help         # Show help
#

#==============================================================================
# ERROR HANDLING - Improved for better debugging
#==============================================================================
# Don't use set -e globally - handle errors explicitly for better feedback
# set -e  # REMOVED - causes silent failures

# Trap errors and provide useful feedback
trap 'handle_error $? $LINENO "$BASH_COMMAND"' ERR

handle_error() {
    local exit_code=$1
    local line_number=$2
    local command="$3"
    
    # Only show error if it's a real failure (not from conditionals)
    if [ $exit_code -ne 0 ]; then
        echo ""
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}ERROR: Command failed with exit code $exit_code${NC}"
        echo -e "${RED}Line: $line_number${NC}"
        echo -e "${RED}Command: $command${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo "For troubleshooting, check the log file:"
        echo "  $ASTRO_HOME/.install.log"
        echo ""
        echo "Or run: astro doctor"
    fi
}

#==============================================================================
# CONFIGURATION
#==============================================================================
# Version
VERSION="1.1.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# Directory configuration
ASTRO_HOME="${ASTRO_HOME:-$HOME/.astro}"
ASTRO_ENV="$ASTRO_HOME/env"
ASTRO_BIN="$ASTRO_HOME/bin"
ASTRO_DATA="$ASTRO_HOME/data"
ASTRO_CACHE="$ASTRO_HOME/cache"
ASTRO_SCRIPTS="$ASTRO_HOME/scripts"
ASTRO_NOTEBOOKS="$ASTRO_HOME/notebooks"

# State tracking files
STATE_FILE="$ASTRO_HOME/.state"
INSTALL_LOG="$ASTRO_HOME/.install.log"

# URLs for downloads
TOPCAT_URL="https://www.star.bris.ac.uk/~mbt/topcat/topcat-full.jar"

# Installation progress tracking
INSTALL_STEP=0
INSTALL_TOTAL=8

#==============================================================================
# PROGRESS INDICATOR FUNCTIONS
#==============================================================================

# Spinner characters for visual feedback
SPINNER_CHARS='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '

# Show a spinner while a background process runs
# Usage: run_with_spinner "message" command arg1 arg2 ...
run_with_spinner() {
    local message="$1"
    shift
    local cmd=("$@")
    
    # Start the command in background
    "${cmd[@]}" >> "$INSTALL_LOG" 2>&1 &
    local pid=$!
    
    local i=0
    local spin_len=${#SPINNER_CHARS}
    
    # Show spinner while process runs
    while kill -0 "$pid" 2>/dev/null; do
        local char="${SPINNER_CHARS:$i:1}"
        printf "\r   ${CYAN}%s${NC} %s" "$char" "$message"
        i=$(( (i + 1) % spin_len ))
        sleep 0.1
    done
    
    # Get exit status
    wait "$pid"
    local exit_status=$?
    
    # Clear the spinner line
    printf "\r%-60s\r" " "
    
    return $exit_status
}

# Show a simple progress indicator for quick operations
show_progress() {
    local message="$1"
    printf "   ${CYAN}â–¸${NC} %s" "$message"
}

# Mark progress as complete
mark_complete() {
    local message="$1"
    printf "\r   ${GREEN}âœ“${NC} %s\n" "$message"
}

# Mark progress as failed
mark_failed() {
    local message="$1"
    printf "\r   ${RED}âœ—${NC} %s\n" "$message"
}

# Mark progress as warning
mark_warning() {
    local message="$1"
    printf "\r   ${YELLOW}âš ${NC} %s\n" "$message"
}

# Show installation step header with progress bar
show_step() {
    local step_name="$1"
    INSTALL_STEP=$((INSTALL_STEP + 1))
    
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}Step $INSTALL_STEP of $INSTALL_TOTAL: $step_name${NC}"
    show_progress_bar "$INSTALL_STEP" "$INSTALL_TOTAL"
    echo ""
}

# Visual progress bar
show_progress_bar() {
    local current=$1
    local total=$2
    local width=50
    local percent=$((current * 100 / total))
    local filled=$((current * width / total))
    local empty=$((width - filled))
    
    printf "   ${DIM}[${NC}"
    printf "${GREEN}%${filled}s${NC}" | tr ' ' 'â–ˆ'
    printf "${DIM}%${empty}s${NC}" | tr ' ' 'â–‘'
    printf "${DIM}]${NC} %3d%%\n" "$percent"
}

# Show a substep with visual indicator
show_substep() {
    local message="$1"
    echo -e "   ${CYAN}â–¸${NC} $message"
}

# Show substep completion
complete_substep() {
    local message="$1"
    echo -e "   ${GREEN}âœ“${NC} $message"
}

# Show substep warning
warn_substep() {
    local message="$1"
    echo -e "   ${YELLOW}âš ${NC} $message"
}

# Show substep failure
fail_substep() {
    local message="$1"
    echo -e "   ${RED}âœ—${NC} $message"
}

#==============================================================================
# UTILITY FUNCTIONS
#==============================================================================

# Initialize log file safely
init_log() {
    mkdir -p "$ASTRO_HOME" 2>/dev/null || true
    touch "$INSTALL_LOG" 2>/dev/null || true
    echo "" >> "$INSTALL_LOG"
    echo "========================================" >> "$INSTALL_LOG"
    echo "Session started: $(date)" >> "$INSTALL_LOG"
    echo "========================================" >> "$INSTALL_LOG"
}

# Logging functions
log() {
    local msg="[$(date +%T)] $*"
    echo -e "${BLUE}${msg}${NC}"
    [ -f "$INSTALL_LOG" ] && echo "$msg" >> "$INSTALL_LOG"
}

success() {
    local msg="âœ“ $*"
    echo -e "${GREEN}${msg}${NC}"
    [ -f "$INSTALL_LOG" ] && echo "$msg" >> "$INSTALL_LOG"
}

error() {
    local msg="âœ— $*"
    echo -e "${RED}${msg}${NC}"
    [ -f "$INSTALL_LOG" ] && echo "ERROR: $msg" >> "$INSTALL_LOG"
}

warning() {
    local msg="âš  $*"
    echo -e "${YELLOW}${msg}${NC}"
    [ -f "$INSTALL_LOG" ] && echo "WARNING: $msg" >> "$INSTALL_LOG"
}

info() {
    echo -e "${CYAN}$*${NC}"
}

# Print a header box
print_header() {
    local title="$1"
    echo ""
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    printf "${CYAN}â•‘${NC}  ${BOLD}%-62s${NC} ${CYAN}â•‘${NC}\n" "$title"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Print a section divider
print_divider() {
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

#==============================================================================
# STATE MANAGEMENT
#==============================================================================

get_state() {
    local key=$1
    if [ -f "$STATE_FILE" ]; then
        grep "^${key}=" "$STATE_FILE" 2>/dev/null | cut -d'=' -f2 || echo ""
    else
        echo ""
    fi
}

set_state() {
    local key=$1
    local value=$2
    mkdir -p "$ASTRO_HOME" 2>/dev/null || true
    
    if [ -f "$STATE_FILE" ]; then
        # Remove existing key if present (handle errors gracefully)
        sed -i "/^${key}=/d" "$STATE_FILE" 2>/dev/null || true
    fi
    echo "${key}=${value}" >> "$STATE_FILE"
}

is_installed() {
    local component=$1
    [ "$(get_state "installed_${component}")" == "true" ]
}

mark_installed() {
    local component=$1
    set_state "installed_${component}" "true"
}

mark_uninstalled() {
    local component=$1
    set_state "installed_${component}" "false"
}

#==============================================================================
# SYSTEM DETECTION
#==============================================================================

detect_system() {
    show_substep "Reading system information..."
    
    # Detect OS with explicit error handling
    if [ ! -f /etc/os-release ]; then
        fail_substep "Cannot detect Linux distribution"
        error "This script requires Ubuntu or Debian-based Linux"
        error "File /etc/os-release not found"
        return 1
    fi
    
    # Source os-release safely
    # shellcheck source=/dev/null
    source /etc/os-release 2>/dev/null || {
        fail_substep "Failed to read /etc/os-release"
        return 1
    }
    
    OS_ID="${ID:-unknown}"
    OS_VERSION="${VERSION_ID:-unknown}"
    OS_NAME="${PRETTY_NAME:-Unknown Linux}"
    ID_LIKE="${ID_LIKE:-}"
    
    complete_substep "Detected: $OS_NAME"
    
    # Verify compatible OS
    show_substep "Checking OS compatibility..."
    
    local is_compatible=false
    if [[ "$OS_ID" == "ubuntu" ]] || [[ "$OS_ID" == "debian" ]]; then
        is_compatible=true
    elif [[ "$ID_LIKE" == *"ubuntu"* ]] || [[ "$ID_LIKE" == *"debian"* ]]; then
        is_compatible=true
    fi
    
    if [ "$is_compatible" = false ]; then
        warn_substep "This installer is optimized for Ubuntu/Debian"
        echo ""
        echo -e "   ${YELLOW}Detected: $OS_NAME${NC}"
        echo -e "   ${YELLOW}The installer may still work, but is not officially tested.${NC}"
        echo ""
        read -p "   Continue anyway? (y/N): " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo ""
            echo "   Installation cancelled by user"
            return 1
        fi
        echo ""
    else
        complete_substep "OS is compatible"
    fi
    
    # Detect shell configuration file
    show_substep "Detecting shell configuration..."
    
    local user_shell
    user_shell=$(basename "${SHELL:-/bin/bash}")
    
    case "$user_shell" in
        zsh)
            SHELL_CONFIG="$HOME/.zshrc"
            SHELL_TYPE="zsh"
            ;;
        bash)
            SHELL_CONFIG="$HOME/.bashrc"
            SHELL_TYPE="bash"
            ;;
        *)
            SHELL_CONFIG="$HOME/.profile"
            SHELL_TYPE="sh"
            ;;
    esac
    
    complete_substep "Shell: $SHELL_TYPE ($SHELL_CONFIG)"
    
    # Detect display system (X11 or Wayland)
    show_substep "Detecting display system..."
    
    if [ -n "${WAYLAND_DISPLAY:-}" ]; then
        DISPLAY_SYSTEM="wayland"
        complete_substep "Display: Wayland"
    elif [ -n "${DISPLAY:-}" ]; then
        DISPLAY_SYSTEM="x11"
        complete_substep "Display: X11"
    else
        DISPLAY_SYSTEM="unknown"
        warn_substep "Display: Not detected (headless/SSH session?)"
    fi
    
    # Store detection results
    set_state "os_id" "$OS_ID"
    set_state "os_version" "$OS_VERSION"
    set_state "os_name" "$OS_NAME"
    set_state "shell_type" "$SHELL_TYPE"
    set_state "shell_config" "$SHELL_CONFIG"
    set_state "display_system" "$DISPLAY_SYSTEM"
    
    return 0
}

#==============================================================================
# DEPENDENCY MANAGEMENT
#==============================================================================

check_dependencies() {
    local missing=()
    
    show_substep "Checking for curl..."
    if command -v curl >/dev/null 2>&1; then
        complete_substep "curl: installed"
    else
        warn_substep "curl: missing"
        missing+=("curl")
    fi
    
    show_substep "Checking for wget..."
    if command -v wget >/dev/null 2>&1; then
        complete_substep "wget: installed"
    else
        warn_substep "wget: missing"
        missing+=("wget")
    fi
    
    show_substep "Checking for git..."
    if command -v git >/dev/null 2>&1; then
        complete_substep "git: installed"
    else
        warn_substep "git: missing"
        missing+=("git")
    fi
    
    show_substep "Checking for python3..."
    if command -v python3 >/dev/null 2>&1; then
        complete_substep "python3: installed"
    else
        warn_substep "python3: missing"
        missing+=("python3")
    fi
    
    if [ ${#missing[@]} -gt 0 ]; then
        echo ""
        show_substep "Installing missing dependencies: ${missing[*]}"
        
        # Update package list
        if ! sudo apt update -qq >> "$INSTALL_LOG" 2>&1; then
            fail_substep "Failed to update package list"
            error "Please run 'sudo apt update' manually and try again"
            return 1
        fi
        
        # Install missing packages
        if ! sudo apt install -y "${missing[@]}" >> "$INSTALL_LOG" 2>&1; then
            fail_substep "Failed to install dependencies"
            error "Please install these packages manually: ${missing[*]}"
            return 1
        fi
        
        complete_substep "Dependencies installed successfully"
    fi
    
    return 0
}

check_python_version() {
    show_substep "Checking Python version..."
    
    local python_version
    python_version=$(python3 --version 2>&1 | cut -d' ' -f2) || {
        fail_substep "Could not determine Python version"
        return 1
    }
    
    local major minor
    major=$(echo "$python_version" | cut -d'.' -f1)
    minor=$(echo "$python_version" | cut -d'.' -f2)
    
    if [ "$major" -lt 3 ] || { [ "$major" -eq 3 ] && [ "$minor" -lt 10 ]; }; then
        fail_substep "Python $python_version found (need 3.10+)"
        error "Python 3.10 or higher is required"
        error "Current version: $python_version"
        echo ""
        echo "To upgrade Python on Ubuntu:"
        echo "  sudo apt install python3.10"
        return 1
    fi
    
    complete_substep "Python $python_version (meets requirement â‰¥3.10)"
    return 0
}

#==============================================================================
# INSTALLATION COMPONENTS
#==============================================================================

install_base_structure() {
    if is_installed "base_structure"; then
        complete_substep "Directory structure already exists"
        return 0
    fi
    
    show_substep "Creating directory structure..."
    
    # Create all required directories
    local dirs=(
        "$ASTRO_HOME"
        "$ASTRO_ENV"
        "$ASTRO_BIN"
        "$ASTRO_DATA/samples"
        "$ASTRO_DATA/results"
        "$ASTRO_CACHE"
        "$ASTRO_SCRIPTS"
        "$ASTRO_NOTEBOOKS/tutorials"
        "$ASTRO_NOTEBOOKS/projects"
        "$ASTRO_NOTEBOOKS/examples"
        "$ASTRO_HOME/projects/learning"
        "$ASTRO_HOME/projects/research"
    )
    
    for dir in "${dirs[@]}"; do
        if ! mkdir -p "$dir" 2>>"$INSTALL_LOG"; then
            fail_substep "Failed to create $dir"
            return 1
        fi
    done
    
    # Initialize log file header
    {
        echo "=== Astronomy Starter Kit Installation Log ==="
        echo "Started: $(date)"
        echo "System: ${OS_NAME:-Unknown}"
        echo "Shell: ${SHELL_TYPE:-Unknown}"
        echo "Display: ${DISPLAY_SYSTEM:-Unknown}"
        echo ""
    } >> "$INSTALL_LOG"
    
    mark_installed "base_structure"
    complete_substep "Directory structure created"
    return 0
}

install_python_environment() {
    if is_installed "python_env"; then
        complete_substep "Python environment already installed"
        return 0
    fi
    
    echo ""
    echo -e "   ${YELLOW}Note: This step takes 5-10 minutes depending on your internet speed${NC}"
    echo ""
    
    # Ensure python3-venv is installed (required on Ubuntu)
    show_substep "Checking python3-venv..."
    if ! dpkg -l python3-venv >/dev/null 2>&1; then
        show_substep "Installing python3-venv and build tools..."
        
        if ! sudo apt update -qq >> "$INSTALL_LOG" 2>&1; then
            fail_substep "Failed to update package list"
            return 1
        fi
        
        if ! sudo apt install -y python3-venv python3-dev python3-pip build-essential >> "$INSTALL_LOG" 2>&1; then
            fail_substep "Failed to install Python development packages"
            return 1
        fi
        complete_substep "Python development packages installed"
    else
        complete_substep "python3-venv already installed"
    fi
    
    # Remove existing environment if corrupted
    if [ -d "$ASTRO_ENV" ] && [ ! -f "$ASTRO_ENV/bin/activate" ]; then
        show_substep "Removing corrupted environment..."
        rm -rf "$ASTRO_ENV"
        complete_substep "Corrupted environment removed"
    fi
    
    # Create virtual environment
    show_substep "Creating virtual environment..."
    if ! python3 -m venv "$ASTRO_ENV" >> "$INSTALL_LOG" 2>&1; then
        fail_substep "Failed to create virtual environment"
        error "Try running: python3 -m venv $ASTRO_ENV"
        return 1
    fi
    complete_substep "Virtual environment created"
    
    # Activate environment
    # shellcheck source=/dev/null
    source "$ASTRO_ENV/bin/activate" || {
        fail_substep "Failed to activate virtual environment"
        return 1
    }
    
    # Upgrade pip first
    show_substep "Upgrading pip, setuptools, wheel..."
    if run_with_spinner "Upgrading pip" pip install --upgrade pip setuptools wheel; then
        complete_substep "pip, setuptools, wheel upgraded"
    else
        fail_substep "Failed to upgrade pip"
        deactivate
        return 1
    fi
    
    # Install packages in groups with visual feedback
    show_substep "Installing numpy, scipy, matplotlib, pandas..."
    if run_with_spinner "Installing core scientific libraries" pip install numpy scipy matplotlib pandas; then
        complete_substep "Core scientific libraries installed"
    else
        fail_substep "Failed to install core scientific libraries"
        deactivate
        return 1
    fi
    
    show_substep "Installing Jupyter Lab..."
    if run_with_spinner "Installing Jupyter" pip install jupyter jupyterlab ipywidgets ipykernel; then
        complete_substep "Jupyter Lab installed"
    else
        fail_substep "Failed to install Jupyter"
        deactivate
        return 1
    fi
    
    show_substep "Installing astropy..."
    if run_with_spinner "Installing astronomy libraries" pip install astropy pytz python-dateutil; then
        complete_substep "Astropy installed"
    else
        fail_substep "Failed to install astronomy libraries"
        deactivate
        return 1
    fi
    
    show_substep "Installing visualization tools (plotly, seaborn, bokeh)..."
    if run_with_spinner "Installing visualization tools" pip install plotly seaborn bokeh; then
        complete_substep "Visualization tools installed"
    else
        warn_substep "Some visualization tools failed (non-critical)"
    fi
    
    # Register Jupyter kernel
    show_substep "Registering Jupyter kernel..."
    if python -m ipykernel install --user --name=astro --display-name="Astronomy Python" >> "$INSTALL_LOG" 2>&1; then
        complete_substep "Jupyter kernel registered"
    else
        warn_substep "Jupyter kernel registration failed (non-critical)"
    fi
    
    deactivate
    
    mark_installed "python_env"
    return 0
}

install_astronomy_tools() {
    if is_installed "astro_tools"; then
        complete_substep "Astronomy tools already installed"
        return 0
    fi
    
    # Install XWayland for GUI support on Wayland systems
    if [ "${DISPLAY_SYSTEM:-}" == "wayland" ]; then
        show_substep "Installing XWayland for GUI compatibility..."
        if sudo apt install -y xwayland >> "$INSTALL_LOG" 2>&1; then
            complete_substep "XWayland installed"
        else
            warn_substep "XWayland installation failed (GUI tools may have issues)"
        fi
    fi
    
    # Install DS9 FITS viewer
    show_substep "Checking for DS9..."
    if command -v ds9 >/dev/null 2>&1; then
        complete_substep "DS9 already installed"
    else
        show_substep "Installing DS9 FITS image viewer..."
        if sudo apt install -y saods9 >> "$INSTALL_LOG" 2>&1; then
            complete_substep "DS9 installed"
        else
            warn_substep "DS9 installation failed (optional tool)"
        fi
    fi
    
    mark_installed "astro_tools"
    return 0
}

install_topcat() {
    if is_installed "topcat"; then
        complete_substep "TOPCAT already installed"
        return 0
    fi
    
    # Install Java (required for TOPCAT)
    show_substep "Checking for Java..."
    if command -v java >/dev/null 2>&1; then
        local java_version
        java_version=$(java -version 2>&1 | head -1)
        complete_substep "Java found: $java_version"
    else
        show_substep "Installing Java runtime..."
        # Try OpenJDK 21 first (Ubuntu 24.04), fall back to 17 (Ubuntu 22.04)
        if sudo apt install -y openjdk-21-jre >> "$INSTALL_LOG" 2>&1; then
            complete_substep "OpenJDK 21 installed"
        elif sudo apt install -y openjdk-17-jre >> "$INSTALL_LOG" 2>&1; then
            complete_substep "OpenJDK 17 installed"
        else
            fail_substep "Failed to install Java"
            error "TOPCAT requires Java. Install manually with: sudo apt install default-jre"
            return 1
        fi
    fi
    
    # Download TOPCAT if not cached
    if [ ! -f "$ASTRO_CACHE/topcat-full.jar" ]; then
        show_substep "Downloading TOPCAT (~50MB)..."
        echo ""
        
        # Use wget with progress bar
        if wget --progress=bar:force:noscroll "$TOPCAT_URL" -O "$ASTRO_CACHE/topcat-full.jar" 2>&1 | \
           grep --line-buffered "%" | \
           sed -u -e "s/^/   /" ; then
            echo ""
            complete_substep "TOPCAT downloaded"
        else
            fail_substep "Failed to download TOPCAT"
            rm -f "$ASTRO_CACHE/topcat-full.jar"
            return 1
        fi
    else
        complete_substep "TOPCAT already cached"
    fi
    
    # Create TOPCAT launcher script
    show_substep "Creating TOPCAT launcher..."
    cat > "$ASTRO_BIN/topcat" << 'EOFTOPCAT'
#!/bin/bash
# TOPCAT Launcher - Astronomy Starter Kit
# Handles both X11 and Wayland display systems

# Set up display environment
export DISPLAY="${DISPLAY:-:0}"

# Wayland compatibility (for Ubuntu 22.04+ with Wayland)
if [ -n "$WAYLAND_DISPLAY" ]; then
    export WAYLAND_DISPLAY="${WAYLAND_DISPLAY:-wayland-0}"
    # Find Xwayland auth file
    XAUTH_FILE=$(ls /run/user/$(id -u)/.mutter-Xwaylandauth* 2>/dev/null | head -1)
    if [ -n "$XAUTH_FILE" ]; then
        export XAUTHORITY="$XAUTH_FILE"
    fi
fi

# Launch TOPCAT
TOPCAT_JAR="$HOME/.astro/cache/topcat-full.jar"

if [ ! -f "$TOPCAT_JAR" ]; then
    echo "Error: TOPCAT not found at $TOPCAT_JAR"
    echo "Run 'astro repair' to fix this"
    exit 1
fi

# Run with appropriate Java options
exec java -Djava.awt.headless=false \
          -Dsun.java2d.xrender=false \
          -jar "$TOPCAT_JAR" "$@"
EOFTOPCAT
    
    chmod +x "$ASTRO_BIN/topcat"
    
    mark_installed "topcat"
    complete_substep "TOPCAT launcher created"
    return 0
}

setup_shell_integration() {
    if is_installed "shell_config"; then
        complete_substep "Shell integration already configured"
        return 0
    fi
    
    # Backup existing shell config
    show_substep "Backing up shell configuration..."
    if [ -f "$SHELL_CONFIG" ]; then
        local backup_file="${SHELL_CONFIG}.backup.astro.$(date +%Y%m%d_%H%M%S)"
        if cp "$SHELL_CONFIG" "$backup_file" 2>>"$INSTALL_LOG"; then
            complete_substep "Backed up to $backup_file"
        else
            warn_substep "Could not create backup (continuing anyway)"
        fi
    fi
    
    # Remove any existing astro configuration blocks
    show_substep "Removing old configuration (if any)..."
    if [ -f "$SHELL_CONFIG" ]; then
        sed -i '/# ==== ASTRO ENVIRONMENT ====/,/# ==== END ASTRO ====/d' "$SHELL_CONFIG" 2>/dev/null || true
    fi
    complete_substep "Old configuration removed"
    
    # Add new configuration
    show_substep "Adding new shell configuration..."
    cat >> "$SHELL_CONFIG" << EOFSHELL

# ==== ASTRO ENVIRONMENT ====
# Astronomy Starter Kit - https://github.com/RedChaosWolf92/astronomy-starter-kit
# Added: $(date +%Y-%m-%d)

# Environment paths
export ASTRO_HOME="$ASTRO_HOME"
export PATH="\$ASTRO_HOME/bin:\$PATH"

# Quick activation alias
alias astro-activate='source "\$ASTRO_HOME/env/bin/activate" && cd "\$ASTRO_HOME" && echo "ðŸ”­ Astronomy environment activated"'

# Display configuration for GUI applications (X11/Wayland compatibility)
export DISPLAY="\${DISPLAY:-:0}"
if [ -n "\$WAYLAND_DISPLAY" ]; then
    export XAUTHORITY="\$(ls /run/user/\$(id -u)/.mutter-Xwaylandauth* 2>/dev/null | head -1)"
fi

# ==== END ASTRO ====
EOFSHELL
    
    mark_installed "shell_config"
    complete_substep "Shell configuration added to $SHELL_CONFIG"
    return 0
}

create_wrapper_scripts() {
    if is_installed "wrappers"; then
        complete_substep "Wrapper scripts already created"
        return 0
    fi
    
    # Jupyter launcher
    show_substep "Creating Jupyter launcher..."
    cat > "$ASTRO_BIN/astro-jupyter" << 'EOFJUPYTER'
#!/bin/bash
# Jupyter Lab Launcher - Astronomy Starter Kit

source "$HOME/.astro/env/bin/activate"
cd "$HOME/.astro/notebooks"

echo "ðŸ”­ Launching Jupyter Lab..."
echo "   Notebooks directory: $HOME/.astro/notebooks"

exec jupyter lab
EOFJUPYTER
    complete_substep "Jupyter launcher created"
    
    # Python launcher
    show_substep "Creating Python launcher..."
    cat > "$ASTRO_BIN/astro-python" << 'EOFPYTHON'
#!/bin/bash
# Python Launcher - Astronomy Starter Kit

source "$HOME/.astro/env/bin/activate"
exec python "$@"
EOFPYTHON
    complete_substep "Python launcher created"
    
    # DS9 launcher (with display fix)
    show_substep "Creating DS9 launcher..."
    cat > "$ASTRO_BIN/astro-ds9" << 'EOFDS9'
#!/bin/bash
# DS9 Launcher - Astronomy Starter Kit

export DISPLAY="${DISPLAY:-:0}"

if [ -n "$WAYLAND_DISPLAY" ]; then
    XAUTH_FILE=$(ls /run/user/$(id -u)/.mutter-Xwaylandauth* 2>/dev/null | head -1)
    [ -n "$XAUTH_FILE" ] && export XAUTHORITY="$XAUTH_FILE"
fi

exec ds9 "$@"
EOFDS9
    complete_substep "DS9 launcher created"
    
    # Make all scripts executable
    show_substep "Setting executable permissions..."
    chmod +x "$ASTRO_BIN"/astro-* 2>>"$INSTALL_LOG"
    chmod +x "$ASTRO_BIN"/topcat 2>>"$INSTALL_LOG" || true
    complete_substep "Permissions set"
    
    mark_installed "wrappers"
    return 0
}

create_readme() {
    show_substep "Creating README..."
    
    cat > "$ASTRO_HOME/README.md" << 'EOFREADME'
# ðŸ”­ Astronomy Starter Kit

Your astronomy development environment is ready!

## Quick Start

```bash
astro                  # Show available commands
astro jupyter          # Launch Jupyter Lab
astro topcat           # Launch TOPCAT catalog tool
astro python           # Python with astronomy libraries
astro-activate         # Activate Python environment manually
```

## Directory Structure

```
~/.astro/
â”œâ”€â”€ env/               # Python virtual environment
â”œâ”€â”€ bin/               # Launcher scripts
â”œâ”€â”€ data/              # Your data files
â”‚   â”œâ”€â”€ samples/       # Sample datasets
â”‚   â””â”€â”€ results/       # Analysis results
â”œâ”€â”€ notebooks/         # Jupyter notebooks
â”‚   â”œâ”€â”€ tutorials/     # Learning materials
â”‚   â”œâ”€â”€ projects/      # Your projects
â”‚   â””â”€â”€ examples/      # Example notebooks
â”œâ”€â”€ scripts/           # Custom Python scripts
â”œâ”€â”€ cache/             # Downloaded tools (TOPCAT, etc.)
â””â”€â”€ projects/          # Research projects
```

## Installed Tools

- **Python Environment**: numpy, scipy, matplotlib, pandas, astropy
- **Jupyter Lab**: Interactive notebook development
- **TOPCAT**: Catalog and table analysis
- **DS9**: FITS image viewer
- **Plotly/Seaborn/Bokeh**: Data visualization

## Useful Commands

```bash
astro status           # Check installation status
astro doctor           # Diagnose problems
astro repair           # Fix broken components
astro update           # Update Python packages
astro uninstall        # Remove everything
```

## Documentation

- Project: https://github.com/RedChaosWolf92/astronomy-starter-kit
- Astropy: https://docs.astropy.org
- TOPCAT: https://www.star.bris.ac.uk/~mbt/topcat/

## Getting Help

If you encounter issues, run:
```bash
astro doctor
```

For more help, visit:
https://github.com/RedChaosWolf92/astronomy-starter-kit/issues
EOFREADME
    
    complete_substep "README created at $ASTRO_HOME/README.md"
    return 0
}

#==============================================================================
# FULL INSTALLATION
#==============================================================================

run_full_install() {
    local start_time
    start_time=$(date +%s)
    
    # Initialize logging
    init_log
    
    print_header "ASTRONOMY STARTER KIT - First Time Setup"
    
    echo -e "${BOLD}This will install:${NC}"
    echo "  â€¢ Python scientific environment (numpy, scipy, matplotlib, pandas)"
    echo "  â€¢ Astronomy libraries (astropy)"
    echo "  â€¢ Jupyter Lab for interactive development"
    echo "  â€¢ TOPCAT for catalog analysis"
    echo "  â€¢ DS9 for FITS image viewing"
    echo "  â€¢ Convenience launcher scripts"
    echo ""
    echo -e "${YELLOW}Installation location:${NC} $ASTRO_HOME"
    echo -e "${YELLOW}Estimated time:${NC} 10-15 minutes"
    echo -e "${YELLOW}Required disk space:${NC} ~2 GB"
    echo ""
    
    read -p "Continue with installation? (Y/n): " -r
    echo
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        echo "Installation cancelled"
        exit 0
    fi
    
    echo ""
    echo -e "${GREEN}${BOLD}ðŸš€ Starting installation...${NC}"
    echo ""
    echo -e "${DIM}Progress will be shown for each step.${NC}"
    echo -e "${DIM}Full log: $INSTALL_LOG${NC}"
    
    # Reset step counter
    INSTALL_STEP=0
    
    # Step 1: Detect system
    show_step "Detecting system configuration"
    if ! detect_system; then
        error "System detection failed. Check the log: $INSTALL_LOG"
        exit 1
    fi
    
    # Step 2: Check dependencies
    show_step "Checking and installing dependencies"
    if ! check_dependencies; then
        error "Dependency check failed. Check the log: $INSTALL_LOG"
        exit 1
    fi
    if ! check_python_version; then
        error "Python version check failed."
        exit 1
    fi
    
    # Step 3: Create directory structure
    show_step "Creating directory structure"
    if ! install_base_structure; then
        error "Failed to create directories. Check the log: $INSTALL_LOG"
        exit 1
    fi
    
    # Step 4: Python environment (longest step)
    show_step "Setting up Python environment"
    if ! install_python_environment; then
        error "Python environment setup failed. Check the log: $INSTALL_LOG"
        exit 1
    fi
    
    # Step 5: Astronomy tools
    show_step "Installing astronomy tools"
    if ! install_astronomy_tools; then
        warning "Some astronomy tools failed to install (continuing)"
    fi
    
    # Step 6: TOPCAT
    show_step "Installing TOPCAT"
    if ! install_topcat; then
        warning "TOPCAT installation failed (can be installed later with 'astro repair')"
    fi
    
    # Step 7: Shell integration
    show_step "Configuring shell integration"
    if ! setup_shell_integration; then
        error "Shell configuration failed. Check the log: $INSTALL_LOG"
        exit 1
    fi
    
    # Step 8: Wrapper scripts and README
    show_step "Creating launcher scripts"
    if ! create_wrapper_scripts; then
        error "Failed to create wrapper scripts. Check the log: $INSTALL_LOG"
        exit 1
    fi
    create_readme
    
    # Mark installation as complete
    set_state "fully_installed" "true"
    set_state "install_date" "$(date +%Y-%m-%d)"
    set_state "install_version" "$VERSION"
    
    local end_time
    end_time=$(date +%s)
    local duration=$((end_time - start_time))
    local minutes=$((duration / 60))
    local seconds=$((duration % 60))
    
    echo ""
    echo ""
    print_header "âœ¨ INSTALLATION COMPLETE!"
    
    echo -e "${GREEN}${BOLD}âœ“ Installation completed in ${minutes}m ${seconds}s${NC}"
    echo ""
    print_divider
    echo ""
    echo -e "${BOLD}Next steps:${NC}"
    echo ""
    echo "1. ${YELLOW}Reload your shell:${NC}"
    echo "   source $SHELL_CONFIG"
    echo "   ${DIM}# Or close and reopen your terminal${NC}"
    echo ""
    echo "2. ${YELLOW}Start using the tools:${NC}"
    echo "   astro                # Show command menu"
    echo "   astro jupyter        # Launch Jupyter Lab"
    echo "   astro topcat         # Launch TOPCAT"
    echo "   astro-activate       # Activate Python environment"
    echo ""
    echo "3. ${YELLOW}Read the documentation:${NC}"
    echo "   $ASTRO_HOME/README.md"
    echo ""
    print_divider
    echo ""
    echo -e "${CYAN}${BOLD}Happy exploring! ðŸ”­âœ¨${NC}"
    echo ""
}

#==============================================================================
# COMMAND HANDLERS
#==============================================================================

cmd_status() {
    print_header "ASTRONOMY STARTER KIT - Status"
    
    if [ "$(get_state fully_installed)" == "true" ]; then
        echo -e "${GREEN}${BOLD}âœ“ Environment installed${NC}"
        echo ""
        echo "  Version:      $(get_state install_version)"
        echo "  Install date: $(get_state install_date)"
        echo "  Location:     $ASTRO_HOME"
        echo "  Shell:        $(get_state shell_type)"
        echo "  Display:      $(get_state display_system)"
        echo ""
        
        print_divider
        echo ""
        echo -e "${BOLD}Components:${NC}"
        is_installed "base_structure" && echo -e "  ${GREEN}âœ“${NC} Directory structure" || echo -e "  ${RED}âœ—${NC} Directory structure"
        is_installed "python_env" && echo -e "  ${GREEN}âœ“${NC} Python environment" || echo -e "  ${RED}âœ—${NC} Python environment"
        is_installed "astro_tools" && echo -e "  ${GREEN}âœ“${NC} Astronomy tools (DS9)" || echo -e "  ${RED}âœ—${NC} Astronomy tools"
        is_installed "topcat" && echo -e "  ${GREEN}âœ“${NC} TOPCAT" || echo -e "  ${RED}âœ—${NC} TOPCAT"
        is_installed "shell_config" && echo -e "  ${GREEN}âœ“${NC} Shell configuration" || echo -e "  ${RED}âœ—${NC} Shell configuration"
        is_installed "wrappers" && echo -e "  ${GREEN}âœ“${NC} Wrapper scripts" || echo -e "  ${RED}âœ—${NC} Wrapper scripts"
        echo ""
        
        print_divider
        echo ""
        echo -e "${BOLD}Quick commands:${NC}"
        echo "  astro jupyter      Launch Jupyter Lab"
        echo "  astro topcat       Launch TOPCAT"
        echo "  astro python       Launch Python"
        echo "  astro-activate     Activate environment"
        echo ""
    else
        echo -e "${YELLOW}âš  Environment not fully installed${NC}"
        echo ""
        echo "Run 'astro' to complete installation"
        echo ""
    fi
}

cmd_doctor() {
    print_header "ASTRONOMY STARTER KIT - Diagnostics"
    
    local issues=0
    local warnings=0
    
    echo -e "${BOLD}Running health checks...${NC}"
    echo ""
    
    # Check 1: Directory structure
    show_substep "Checking ASTRO_HOME directory..."
    if [ -d "$ASTRO_HOME" ]; then
        complete_substep "ASTRO_HOME directory exists"
    else
        fail_substep "ASTRO_HOME directory missing"
        issues=$((issues + 1))
    fi
    
    # Check 2: Python environment
    show_substep "Checking Python environment..."
    if [ -d "$ASTRO_ENV" ] && [ -f "$ASTRO_ENV/bin/activate" ]; then
        complete_substep "Python environment exists"
        
        # Check core packages
        show_substep "Checking core packages..."
        # shellcheck source=/dev/null
        source "$ASTRO_ENV/bin/activate"
        if python -c "import numpy, matplotlib, astropy" 2>/dev/null; then
            complete_substep "Core packages (numpy, matplotlib, astropy) OK"
        else
            fail_substep "Core packages missing or broken"
            issues=$((issues + 1))
        fi
        deactivate
    else
        fail_substep "Python environment missing or corrupted"
        issues=$((issues + 1))
    fi
    
    # Check 3: TOPCAT
    show_substep "Checking TOPCAT..."
    if [ -f "$ASTRO_CACHE/topcat-full.jar" ]; then
        complete_substep "TOPCAT JAR file present"
    else
        warn_substep "TOPCAT not downloaded"
        warnings=$((warnings + 1))
    fi
    
    # Check 4: Java (for TOPCAT)
    show_substep "Checking Java..."
    if command -v java >/dev/null 2>&1; then
        local java_version
        java_version=$(java -version 2>&1 | head -1)
        complete_substep "Java installed: $java_version"
    else
        warn_substep "Java not installed (required for TOPCAT)"
        warnings=$((warnings + 1))
    fi
    
    # Check 5: Shell configuration
    show_substep "Checking shell configuration..."
    # Re-detect system to get SHELL_CONFIG
    local user_shell
    user_shell=$(basename "${SHELL:-/bin/bash}")
    case "$user_shell" in
        zsh) SHELL_CONFIG="$HOME/.zshrc" ;;
        bash) SHELL_CONFIG="$HOME/.bashrc" ;;
        *) SHELL_CONFIG="$HOME/.profile" ;;
    esac
    
    if grep -q "ASTRO_HOME" "$SHELL_CONFIG" 2>/dev/null; then
        complete_substep "Shell configuration present in $SHELL_CONFIG"
    else
        warn_substep "Shell configuration missing from $SHELL_CONFIG"
        warnings=$((warnings + 1))
    fi
    
    # Check 6: Display system
    show_substep "Checking display system..."
    if [ -n "${WAYLAND_DISPLAY:-}" ]; then
        info "   Display: Wayland detected"
        if command -v Xwayland >/dev/null 2>&1 || dpkg -l xwayland >/dev/null 2>&1; then
            complete_substep "XWayland available for GUI compatibility"
        else
            warn_substep "XWayland not installed (GUI tools may not work)"
            warnings=$((warnings + 1))
        fi
    elif [ -n "${DISPLAY:-}" ]; then
        complete_substep "Display: X11 (native support)"
    else
        warn_substep "Display system not detected (headless/SSH?)"
        warnings=$((warnings + 1))
    fi
    
    # Summary
    echo ""
    print_divider
    echo ""
    
    if [ $issues -eq 0 ] && [ $warnings -eq 0 ]; then
        echo -e "${GREEN}${BOLD}âœ“ All checks passed!${NC}"
        echo "  Your astronomy environment is healthy."
    elif [ $issues -eq 0 ]; then
        echo -e "${YELLOW}${BOLD}âš  $warnings warning(s) found${NC}"
        echo "  Environment is functional but some features may be limited."
        echo "  Run 'astro repair' to fix optional components."
    else
        echo -e "${RED}${BOLD}âœ— $issues issue(s) found${NC}"
        echo "  Run 'astro repair' to attempt automatic fixes."
    fi
    echo ""
}

cmd_repair() {
    print_header "ASTRONOMY STARTER KIT - Repair"
    
    echo -e "${BOLD}Attempting to repair environment...${NC}"
    echo ""
    
    # Initialize logging
    init_log
    
    # Re-detect system
    local user_shell
    user_shell=$(basename "${SHELL:-/bin/bash}")
    case "$user_shell" in
        zsh) SHELL_CONFIG="$HOME/.zshrc"; SHELL_TYPE="zsh" ;;
        bash) SHELL_CONFIG="$HOME/.bashrc"; SHELL_TYPE="bash" ;;
        *) SHELL_CONFIG="$HOME/.profile"; SHELL_TYPE="sh" ;;
    esac
    
    if [ -n "${WAYLAND_DISPLAY:-}" ]; then
        DISPLAY_SYSTEM="wayland"
    elif [ -n "${DISPLAY:-}" ]; then
        DISPLAY_SYSTEM="x11"
    else
        DISPLAY_SYSTEM="unknown"
    fi
    
    # Repair base structure
    if [ ! -d "$ASTRO_HOME" ]; then
        show_substep "Recreating directory structure..."
        mark_uninstalled "base_structure"
        install_base_structure
    fi
    
    # Repair Python environment
    if [ ! -f "$ASTRO_ENV/bin/activate" ]; then
        show_substep "Recreating Python environment..."
        rm -rf "$ASTRO_ENV" 2>/dev/null || true
        mark_uninstalled "python_env"
        install_python_environment
    fi
    
    # Repair TOPCAT
    if [ ! -f "$ASTRO_CACHE/topcat-full.jar" ]; then
        show_substep "Re-downloading TOPCAT..."
        mark_uninstalled "topcat"
        install_topcat
    fi
    
    # Repair shell configuration
    if ! grep -q "ASTRO_HOME" "$SHELL_CONFIG" 2>/dev/null; then
        show_substep "Restoring shell configuration..."
        mark_uninstalled "shell_config"
        setup_shell_integration
    fi
    
    # Repair wrapper scripts
    if [ ! -f "$ASTRO_BIN/astro-jupyter" ]; then
        show_substep "Recreating wrapper scripts..."
        mark_uninstalled "wrappers"
        create_wrapper_scripts
    fi
    
    echo ""
    success "Repair complete!"
    echo ""
    echo "Run 'astro doctor' to verify the repairs"
    echo ""
}

cmd_jupyter() {
    if ! is_installed "python_env"; then
        error "Python environment not installed"
        echo "Run 'astro' to complete installation first"
        exit 1
    fi
    
    echo -e "${CYAN}ðŸ”­ Launching Jupyter Lab...${NC}"
    echo "   Notebooks: $ASTRO_NOTEBOOKS"
    echo ""
    
    # shellcheck source=/dev/null
    source "$ASTRO_ENV/bin/activate"
    cd "$ASTRO_NOTEBOOKS"
    exec jupyter lab
}

cmd_topcat() {
    if [ ! -f "$ASTRO_CACHE/topcat-full.jar" ]; then
        error "TOPCAT not installed"
        echo "Run 'astro repair' to install TOPCAT"
        exit 1
    fi
    
    echo -e "${CYAN}ðŸ”­ Launching TOPCAT...${NC}"
    exec "$ASTRO_BIN/topcat" "$@"
}

cmd_ds9() {
    if ! command -v ds9 >/dev/null 2>&1; then
        error "DS9 not installed"
        echo "Install with: sudo apt install saods9"
        exit 1
    fi
    
    echo -e "${CYAN}ðŸ”­ Launching DS9...${NC}"
    exec "$ASTRO_BIN/astro-ds9" "$@"
}

cmd_python() {
    if ! is_installed "python_env"; then
        error "Python environment not installed"
        echo "Run 'astro' to complete installation first"
        exit 1
    fi
    
    # shellcheck source=/dev/null
    source "$ASTRO_ENV/bin/activate"
    exec python "$@"
}

cmd_update() {
    if ! is_installed "python_env"; then
        error "Python environment not installed"
        exit 1
    fi
    
    print_header "ASTRONOMY STARTER KIT - Update"
    
    init_log
    
    echo -e "${BOLD}Updating Python packages...${NC}"
    echo ""
    
    # shellcheck source=/dev/null
    source "$ASTRO_ENV/bin/activate"
    
    show_substep "Upgrading pip, setuptools, wheel..."
    if pip install --upgrade pip setuptools wheel >> "$INSTALL_LOG" 2>&1; then
        complete_substep "pip, setuptools, wheel upgraded"
    else
        warn_substep "Failed to upgrade pip"
    fi
    
    show_substep "Upgrading numpy, scipy, matplotlib, pandas..."
    if pip install --upgrade numpy scipy matplotlib pandas >> "$INSTALL_LOG" 2>&1; then
        complete_substep "Core libraries upgraded"
    else
        warn_substep "Some core libraries failed to upgrade"
    fi
    
    show_substep "Upgrading astropy..."
    if pip install --upgrade astropy >> "$INSTALL_LOG" 2>&1; then
        complete_substep "Astropy upgraded"
    else
        warn_substep "Astropy upgrade failed"
    fi
    
    show_substep "Upgrading Jupyter..."
    if pip install --upgrade jupyter jupyterlab >> "$INSTALL_LOG" 2>&1; then
        complete_substep "Jupyter upgraded"
    else
        warn_substep "Jupyter upgrade failed"
    fi
    
    show_substep "Upgrading visualization tools..."
    if pip install --upgrade plotly seaborn bokeh >> "$INSTALL_LOG" 2>&1; then
        complete_substep "Visualization tools upgraded"
    else
        warn_substep "Some visualization tools failed"
    fi
    
    deactivate
    
    # Update TOPCAT
    if [ -f "$ASTRO_CACHE/topcat-full.jar" ]; then
        show_substep "Checking for TOPCAT updates..."
        local temp_file="/tmp/topcat-check.jar"
        if wget -q "$TOPCAT_URL" -O "$temp_file" 2>/dev/null; then
            local old_size new_size
            old_size=$(stat -c%s "$ASTRO_CACHE/topcat-full.jar" 2>/dev/null || echo "0")
            new_size=$(stat -c%s "$temp_file" 2>/dev/null || echo "0")
            if [ "$new_size" != "$old_size" ]; then
                mv "$temp_file" "$ASTRO_CACHE/topcat-full.jar"
                complete_substep "TOPCAT updated"
            else
                rm -f "$temp_file"
                complete_substep "TOPCAT is already up to date"
            fi
        else
            warn_substep "Could not check TOPCAT updates"
        fi
    fi
    
    set_state "last_update" "$(date +%Y-%m-%d)"
    
    echo ""
    success "Update complete!"
    echo ""
}

cmd_uninstall() {
    print_header "ASTRONOMY STARTER KIT - Uninstall"
    
    echo -e "${RED}${BOLD}WARNING: This will completely remove the astronomy environment${NC}"
    echo ""
    echo "The following will be deleted:"
    echo "  â€¢ $ASTRO_HOME (all files and data)"
    echo "  â€¢ Shell configuration entries"
    echo "  â€¢ Jupyter kernel registration"
    echo ""
    echo -e "${YELLOW}Note: System packages (Java, DS9) will NOT be removed${NC}"
    echo ""
    
    read -p "Type 'uninstall' to confirm: " -r
    echo
    
    if [ "$REPLY" != "uninstall" ]; then
        echo "Uninstall cancelled"
        exit 0
    fi
    
    echo ""
    log "Starting uninstall..."
    
    # Remove Jupyter kernel
    show_substep "Removing Jupyter kernel..."
    if command -v jupyter >/dev/null 2>&1; then
        jupyter kernelspec uninstall astro -y 2>/dev/null || true
    fi
    complete_substep "Jupyter kernel removed"
    
    # Remove shell configuration
    show_substep "Removing shell configuration..."
    local user_shell
    user_shell=$(basename "${SHELL:-/bin/bash}")
    case "$user_shell" in
        zsh) SHELL_CONFIG="$HOME/.zshrc" ;;
        bash) SHELL_CONFIG="$HOME/.bashrc" ;;
        *) SHELL_CONFIG="$HOME/.profile" ;;
    esac
    
    if [ -f "$SHELL_CONFIG" ]; then
        sed -i '/# ==== ASTRO ENVIRONMENT ====/,/# ==== END ASTRO ====/d' "$SHELL_CONFIG" 2>/dev/null || true
    fi
    complete_substep "Shell configuration removed"
    
    # Remove the main directory
    show_substep "Removing $ASTRO_HOME..."
    rm -rf "$ASTRO_HOME"
    complete_substep "Directory removed"
    
    echo ""
    success "Astronomy Starter Kit has been uninstalled"
    echo ""
    echo "To complete removal, reload your shell:"
    echo -e "  ${YELLOW}source $SHELL_CONFIG${NC}"
    echo "  # Or close and reopen your terminal"
    echo ""
    echo "Thank you for using Astronomy Starter Kit! ðŸ”­"
    echo ""
}

cmd_help() {
    print_header "ASTRONOMY STARTER KIT - Help"
    
    echo -e "${BOLD}Version:${NC} $VERSION"
    echo ""
    echo -e "${BOLD}Usage:${NC} astro [command] [options]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo ""
    echo "  ${CYAN}Launch Tools:${NC}"
    echo "    jupyter         Launch Jupyter Lab"
    echo "    topcat          Launch TOPCAT catalog analyzer"
    echo "    ds9             Launch DS9 FITS viewer"
    echo "    python          Launch Python with astronomy environment"
    echo ""
    echo "  ${CYAN}Environment Management:${NC}"
    echo "    status          Show installation status"
    echo "    doctor          Check environment health"
    echo "    repair          Fix broken components"
    echo "    update          Update packages to latest versions"
    echo "    uninstall       Remove the entire environment"
    echo ""
    echo "  ${CYAN}Help:${NC}"
    echo "    help            Show this help message"
    echo "    version         Show version information"
    echo ""
    echo -e "${BOLD}Aliases:${NC}"
    echo "    astro-activate  Activate Python environment directly"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "    astro jupyter              # Start Jupyter Lab"
    echo "    astro topcat catalog.fits  # Open catalog in TOPCAT"
    echo "    astro python script.py     # Run script with astronomy Python"
    echo ""
    echo -e "${BOLD}Troubleshooting:${NC}"
    echo "    astro doctor               # Run diagnostics"
    echo "    astro repair               # Fix common issues"
    echo "    cat ~/.astro/.install.log  # View installation log"
    echo ""
    echo -e "${BOLD}Documentation:${NC}"
    echo "    https://github.com/RedChaosWolf92/astronomy-starter-kit"
    echo ""
}

cmd_version() {
    echo "Astronomy Starter Kit v$VERSION"
    if [ "$(get_state fully_installed)" == "true" ]; then
        echo "Installed: $(get_state install_date)"
        echo "Location: $ASTRO_HOME"
    fi
}

show_menu() {
    print_header "ASTRONOMY STARTER KIT"
    
    echo -e "${BOLD}Quick Commands:${NC}"
    echo ""
    echo "  ${YELLOW}astro jupyter${NC}      Launch Jupyter Lab"
    echo "  ${YELLOW}astro topcat${NC}       Launch TOPCAT catalog tool"
    echo "  ${YELLOW}astro ds9${NC}          Launch DS9 FITS viewer"
    echo "  ${YELLOW}astro python${NC}       Launch Python environment"
    echo ""
    print_divider
    echo ""
    echo -e "${BOLD}Management:${NC}"
    echo ""
    echo "  ${YELLOW}astro status${NC}       Show installation status"
    echo "  ${YELLOW}astro doctor${NC}       Check environment health"
    echo "  ${YELLOW}astro repair${NC}       Fix broken components"
    echo "  ${YELLOW}astro update${NC}       Update packages"
    echo "  ${YELLOW}astro uninstall${NC}    Remove environment"
    echo "  ${YELLOW}astro help${NC}         Show detailed help"
    echo ""
    print_divider
    echo ""
    echo -e "${BOLD}Direct Activation:${NC}"
    echo ""
    echo "  ${YELLOW}astro-activate${NC}     Activate Python environment in current shell"
    echo ""
}

#==============================================================================
# MAIN ENTRY POINT
#==============================================================================

main() {
    # Create home directory if it doesn't exist (for state file access)
    mkdir -p "$ASTRO_HOME" 2>/dev/null || true
    
    # If not installed, run installation
    if [ "$(get_state fully_installed)" != "true" ]; then
        run_full_install
        exit 0
    fi
    
    # Parse command
    case "${1:-}" in
        jupyter)
            shift
            cmd_jupyter "$@"
            ;;
        topcat)
            shift
            cmd_topcat "$@"
            ;;
        ds9)
            shift
            cmd_ds9 "$@"
            ;;
        python)
            shift
            cmd_python "$@"
            ;;
        status)
            cmd_status
            ;;
        doctor)
            cmd_doctor
            ;;
        repair)
            cmd_repair
            ;;
        update)
            cmd_update
            ;;
        uninstall)
            cmd_uninstall
            ;;
        help|--help|-h)
            cmd_help
            ;;
        version|--version|-v)
            cmd_version
            ;;
        "")
            show_menu
            ;;
        *)
            error "Unknown command: $1"
            echo ""
            echo "Run 'astro help' for available commands"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"